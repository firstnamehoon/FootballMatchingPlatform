<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kosta.project.repository.TeamMapper">
	
	<!-- 팀 전체 순위 -->
	<select id="selectTeamRankList" resultType="com.kosta.project.dto.TeamDTO">
		SELECT team_name AS teamName, team_rank AS teamRank, game_count AS gameCount, 
		win_count AS winCount, if(game_count = 0, 0, 100*(win_count/game_count)) AS odds,
		team_tier AS teamTier, team_score AS teamScore 
		FROM teams
		ORDER BY team_score DESC
	</select>
	
	
	<!-- 가입 가능 팀 목록 조회 -->
	<select id="selectPossibleJoinTeam" resultType="com.kosta.project.dto.TeamDTO">
		SELECT t.team_seq AS teamSeq, team_name AS teamName, possible_a AS possA, possible_b AS possB, 
		possible_c AS possC, possible_d AS possD, week_type AS weekType, week_time AS weekTime,
		hope_time AS hopeTime, hometown, COUNT(m.user_id) AS memberCount
		FROM teams t, team_members m
		WHERE t.team_seq = m.team_seq AND recruitment = TRUE
		GROUP BY m.team_seq
	</select>
	
	
	<!-- 팀 생성하기 -->
	<insert id="insertTeam" parameterType="com.kosta.project.dto.TeamDTO">
		INSERT INTO teams(team_name, hometown, week_type, week_time, hope_time, content, team_score, team_tier, 
		game_count, win_count, possible_a, possible_b, possible_c, possible_d, 
		recruitment, team_dismantle_status, leader_id)
		VALUES(#{teamName}, #{homeTown}, #{weekType}, #{weekTime}, #{hopeTime}, #{content}, 100, "D", 0, 0, FALSE,
		TRUE, TRUE, FALSE, TRUE, FALSE, #{leaderID})
	</insert>
	
	<select id="selectTeamSeq" resultType="Integer">
		SELECT team_seq FROM teams WHERE team_name = #{teamName}
	</select>
	
	<insert id="insertTeamMember">
		INSERT INTO team_members(user_id, join_date, team_member_status, team_member_delete,team_seq)
		VALUES (#{userId}, NOW(), FALSE, FALSE, #{teamSeq})
	</insert>
	
	<select id="selectTeamName" resultType="String">
		SELECT team_name FROM teams WHERE team_name = #{teamName}
	</select>
	
	
	<!-- 팀 정보 불러오기 by 모달 -->
	<select id="selectTeamInfoByModal" resultType="com.kosta.project.dto.TeamDTO">
		SELECT team_seq AS teamSeq, team_name AS teamName, game_count AS gameCount, win_count AS winCount, 
		if(game_count = 0, 0, 100*(win_count/game_count)) AS odds, NVL(team_rank, 0) AS teamRank, 
		team_tier AS teamTier, team_score AS teamScore, possible_a AS possA, possible_b AS possB, 
		possible_c AS possC, possible_d AS possD, week_type AS weekType, week_time AS weekTime, 
		hope_time AS hopeTime, hometown, content
		FROM teams 
		WHERE team_seq = #{teamSeq};
	</select>
	
	<select id="selectTeamMemberTierAndCount" resultType="Map">
		SELECT user_tier AS userTier, COUNT(u.user_id) AS tierCount
		FROM team_members m, users u
		WHERE m.team_seq = #{teamSeq} AND m.user_id = u.user_id
		GROUP BY user_tier;
	</select>
	
	<!-- 팀 가입 신청하기 & 가입신청 취소하기 -->
	<insert id="insertTeamApply">
		INSERT INTO applys(user_id, apply_date, apply_status, close_status, team_seq)
		VALUES (#{userId}, NOW(), FALSE, FALSE, #{teamSeq});
	</insert>
	
	<delete id="deleteApplyByTeamSeq">
		DELETE FROM applys WHERE user_id = #{userId} AND team_seq = #{teamSeq};
	</delete>
	
	
	<!-- 가입 신청된 목록 조회 -->
	<select id="selectApplyTeamList" resultType="com.kosta.project.dto.TeamDTO">
		SELECT t.team_seq AS teamSeq,team_name AS teamName, possible_a AS possA, possible_b AS possB, possible_c AS possC, 
		possible_d AS possD, week_type AS weekType, week_time AS weekTime, hope_time AS hopeTime, hometown, 
		COUNT(m.user_id) AS memberCount
		FROM teams t, team_members m, applys a
		WHERE t.team_seq = m.team_seq AND a.team_seq = t.team_seq AND recruitment = TRUE
		AND a.user_id = #{userId} AND apply_status = FALSE AND close_status = FALSE;
	</select>

	
	<!-- 팀원 모집 신청 받기 (신청 허가) -->
	<update id="updateApplyTeamMemberStatus">
		UPDATE applys SET apply_status = TRUE WHERE user_id = #{userId};
	</update>

	
	<!-- 내 팀 정보 조회 (내 팀 정보 Btn) -->
	<select id="selectTeamInfo" resultType="com.kosta.project.dto.TeamDTO">
		SELECT team_seq AS teamSeq, team_name AS teamName, game_count AS gameCount, win_count AS winCount, 
		if(game_count = 0, 0, 100*(win_count/game_count)) AS odds, NVL(team_rank, 0) AS teamRank, team_tier AS teamTier,
		team_score AS teamScore, possible_a AS possA, possible_b AS possB, possible_c AS possC, 
		possible_d AS possD, week_type AS weekType, week_time AS weekTime, hope_time AS hopeTime, hometown, content
		FROM teams 
		WHERE team_seq = (SELECT team_seq FROM team_members WHERE user_id = #{userId} AND team_member_status = FALSE
		AND team_member_delete=FALSE);
	</select>
	

	
</mapper>