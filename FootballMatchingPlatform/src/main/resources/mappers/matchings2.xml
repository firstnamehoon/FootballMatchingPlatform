<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kosta.project.repository.MatchingMapper2">
	
	<!-- 일정표 -->
	<!-- 특정 달에 맞는 매칭 정보 리스트 불러오기 -->
	<select id="selectMatchingListByMonth" resultType="com.kosta.project.dto.MatchingScheduleListDTO">
		SELECT ma.matching_add_seq, m.matching_date, mal.matching_success_status, mal.cancel_status
		FROM matching_adds ma
		JOIN matching_add_lists mal ON ma.matching_add_seq = mal.matching_add_seq
		JOIN matchings m ON mal.matching_seq = m.matching_seq
		WHERE MONTH(m.matching_date) = #{month}
		AND ma.user_id = #{userId}
		ORDER BY m.matching_date desc
	</select>
	
	<!-- 특정 날짜에 맞는 매칭 리스트 불러오기 -->
	<select id="selectMatchingListByDate" resultType="com.kosta.project.dto.MatchingScheduleListDTO">
		SELECT m.matching_seq, m.matching_date, m.matching_time, m.fast_add_status, m.matching_status,
		m.a_score, m.b_score, ma.matching_add_seq,
		mal.matching_add_list_seq, mal.matching_success_status, mal.cancel_status, mal.pay_status,
		mal.review_status, mal.team_status, mal.team, mal.player_number
		FROM matching_adds ma
		JOIN matching_add_lists mal ON ma.matching_add_seq = mal.matching_add_seq
		JOIN matchings m ON mal.matching_seq = m.matching_seq
		WHERE m.matching_date = #{date}
		AND ma.user_id = #{userId}
		ORDER BY m.matching_time asc
	</select>

	<!-- 매칭 리스트 개수 불러오기 -->
	<select id="selectMatchingListCount">
		SELECT COUNT(mal.matching_seq)
		FROM matchings m 
		JOIN matching_add_lists mal ON m.matching_seq = mal.matching_seq
		JOIN matching_adds ma ON mal.matching_add_seq = ma.matching_add_seq
		WHERE ma.user_id = #{userId}
	</select>
	
	<!-- 매칭 리스트 전부 불러오기 -->
	<select id="selectMatchingList" resultType="com.kosta.project.dto.MatchingScheduleListDTO">	
		SELECT m.matching_seq, m.matching_date, m.matching_time, m.fast_add_status, m.matching_status,
		m.a_score, m.b_score, ma.matching_add_seq,
		mal.matching_add_list_seq, mal.matching_success_status, mal.cancel_status, mal.pay_status,
		mal.review_status, mal.team_status, mal.team, mal.player_number
		FROM matching_adds ma
		JOIN matching_add_lists mal ON ma.matching_add_seq = mal.matching_add_seq
		JOIN matchings m ON mal.matching_seq = m.matching_seq
		WHERE ma.user_id = #{userId}
		ORDER BY m.matching_date, m.matching_time desc
	</select>
	
	<!-- 결제 상태 변경하기 -->
	<update id="updatePayStatus" parameterType="com.kosta.project.dto.UserMatchingInfoDTO">
		UPDATE matching_add_lists mal
		JOIN matching_adds ma ON mal.matching_add_seq = ma.matching_add_seq
		SET mal.pay_status = TRUE 
	    WHERE mal.matching_seq = #{matchingSeq} AND ma.user_id = #{userId}
	</update>
	
	<!-- 매칭 삭제하기 -->
	<delete id="deleteMatching">	
		DELETE FROM matching_add_lists
		WHERE matching_add_list_seq = #{matchingAddListSeq};
	</delete>

	<!-- 상대팀 평가 -->
	<!-- 상대팀 리스트 불러오기 -->
	<select id="selectOpposingTeamPlayerList" parameterType="com.kosta.project.dto.UserMatchingInfoDTO"
	resultType="com.kosta.project.dto.UserPlayInfoDTO">
		SELECT u.user_id, u.nickname, mal.team, mal.player_number
		FROM matchings m JOIN matching_add_lists mal ON m.matching_seq = mal.matching_seq
		JOIN matching_adds ma ON mal.matching_add_seq = ma.matching_add_seq
		JOIN users u ON ma.user_id = u.user_id
		WHERE m.matching_seq = #{matchingSeq}
		AND matching_success_status = 1
		AND mal.team !=
			(SELECT mal.team
			FROM matching_add_lists mal
			JOIN matching_adds ma
			ON mal.matching_add_seq = ma.matching_add_seq
			WHERE ma.user_id = #{userId}
			AND mal.matching_seq = #{matchingSeq})
	</select>
	
	<!--  -->
	<update id="updateReviewScore" parameterType="com.kosta.project.dto.UserMatchingInfoDTO">
		update matching_add_lists mal
		JOIN matching_adds ma ON mal.matching_add_seq = ma.matching_add_seq
		set mal.review_score = mal.review_score + #{score}
		WHERE mal.matching_seq = #{matchingSeq} AND ma.user_id = #{userId}
	</update>
	

	<select id="selectPlayerList">
		SELECT u.user_id, u.nickname, mal.team, mal.player_number
		FROM matchings m JOIN matching_add_lists mal ON m.matching_seq = mal.matching_seq
		JOIN matching_adds ma ON mal.matching_add_seq = ma.matching_add_seq
		JOIN users u ON ma.user_id = u.user_id
		WHERE m.matching_seq = #{matchingSeq}
		AND matching_success_status = 1
	</select>
	
	<select id="selectReviewScore" parameterType="com.kosta.project.dto.UserMatchingInfoDTO">
		SELECT mal.review_score
		FROM matching_add_lists mal JOIN matching_adds ma ON mal.matching_add_seq = ma.matching_add_seq
		WHERE mal.matching_seq = #{matchingSeq}
		AND ma.user_id = #{userId}
	</select>
	
	<select id="selectTeamScore" parameterType="com.kosta.project.dto.UserMatchingInfoDTO">
		SELECT
    	CASE
	      	WHEN mal.team = 'A' AND m.a_score &gt; m.b_score THEN 1
	      	WHEN mal.team = 'B' AND m.a_score &lt; m.b_score THEN 1
	      	ELSE 0
    	END AS result
		FROM matchings m
		JOIN matching_add_lists mal ON m.matching_seq = mal.matching_seq
		JOIN matching_adds ma ON mal.matching_add_seq = ma.matching_add_seq
		WHERE ma.user_id = #{userId}
		AND m.matching_seq = #{matchingSeq}
	</select>
	
</mapper>